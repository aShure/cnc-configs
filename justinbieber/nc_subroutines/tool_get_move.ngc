; parameter: new tool pocket
o<tool_get_move> sub
#<f1>=2400.0 (feedrate to move tool down to pocket plane)
(print, change_position_1 X: #<_ini[change_position_1]x>)
o100 if [EXISTS[#<_ini[change_position_1]x>]]
(debug, tool_get_move pocket: #1)
  M70 ;save modal settings
  G53 g1 Z0 F30000
  G64 P0.5

  o<check_tool_presence> call
  ;did a timeout occur at the previous M66? Then the result should be (-1)
   o110 if [#5399 GT -1]
    (MSG, WARNING - Tool detected, but spindle should be empty.)
    M71 ;restore modal settings
    o100 return
   o110 endif
  o120 if [#5399 LT 0]
  (print, tool_get_move 18)
  o101 if [#1 EQ 1]
	G53 G0 Y[#<_ini[change_position_1]Y>]
	G53 G0 X[#<_ini[change_position_1]X>]
	G53 G1 Z-1 F3200
	(debug, tool_get_move 23)
  o101 ELSEIF [#1 EQ 2]
	G53 G0 Y[#<_ini[change_position_2]Y>]
	G53 G0 X[#<_ini[change_position_2]X>]
	G53 G1 Z-1 F3200
	(debug, tool_get_move 28)
  o101 ELSEIF [#1 EQ 3]
	G53 G0 Y[#<_ini[change_position_3]Y>]
	G53 G0 X[#<_ini[change_position_3]X>]
	G53 G1 Z-1 F3200
	(debug, tool_get_move 33)
  o101 ELSEIF [#1 EQ 4]
	G53 G0 Y[#<_ini[change_position_4]Y>]
	G53 G0 X[#<_ini[change_position_4]X>]
	G53 G1 Z-1 F3200
	(debug, tool_get_move 38)
  o101 endif
	;TODO set servo amp max current low at this point to reduce potential crash damage
	G53 G1 Z[#<_ini[change_position_1]Z> + 75] F9600
	M250 	;draw bar down, release tool and flush spindle with air
	G4P0.1
	;TODO check draw bar cylinder position here
	o102 if [#1 EQ 1]
		G53 G1 Z[#<_ini[change_position_1]Z>] F#<f1>
	o102 ELSEIF [#1 EQ 2]
		G53 G1 Z[#<_ini[change_position_2]Z>] F#<f1>
	o102 ELSEIF [#1 EQ 3]
		G53 G1 Z[#<_ini[change_position_3]Z>] F#<f1>
	o102 ELSEIF [#1 EQ 4]
		G53 G1 Z[#<_ini[change_position_4]Z>] F#<f1>
	o102 endif
	
  M251 ; pull draw bar up, clamp tool. There is a tool present in the spindle now.
  G4P0.2 ;TODO Check for tool presence
  G91 ;relative distance mode
  G1 X[#<_ini[change_offset]X>] Y[#<_ini[change_offset]Y>] F3200 ;move gently out of tool pocket
  G90 ;absolute distance mode
; TODO revert servo amp max current to default
  o120 endif
  G53 G1 Z0 F30000

  o<check_tool_presence> call
   o111 if [#5399 LT 1]
    (MSG, WARNING - No tool detected after tool change.)
    M71 ;restore modal settings
    o100 return
   o111 endif

  G53 G0 X[#<_ini[change_position]X>]
  M71 ;restore modal settings
o100 endif
o<tool_get_move> endsub
m2
